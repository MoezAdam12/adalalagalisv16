## متطلبات وحدة تتبع الوقت والفوترة

### نظرة عامة
وحدة تتبع الوقت والفوترة هي جزء أساسي من نظام Adalalegalis لإدارة المكاتب القانونية. تسمح هذه الوحدة للمحامين والموظفين بتسجيل الوقت الذي يقضونه في العمل على القضايا والمهام، وتحويل هذا الوقت إلى فواتير للعملاء. كما توفر أدوات لتحليل إنتاجية الموظفين وربحية القضايا.

### الأهداف
1. تمكين المحامين والموظفين من تسجيل الوقت بدقة وسهولة
2. تحويل سجلات الوقت إلى فواتير بشكل آلي أو يدوي
3. تتبع ساعات العمل القابلة للفوترة وغير القابلة للفوترة
4. توفير تقارير تحليلية عن الإنتاجية والربحية
5. التكامل مع وحدة الإدارة المالية لإنشاء الفواتير وتتبع المدفوعات

### المتطلبات الوظيفية

#### 1. تسجيل الوقت
- **إنشاء إدخالات الوقت**: تسجيل الوقت المستغرق في العمل على قضية أو مهمة
- **تسجيل الوقت المباشر**: ساعة توقيت لتسجيل الوقت أثناء العمل
- **إدخال الوقت بأثر رجعي**: إدخال سجلات الوقت للأنشطة السابقة
- **تصنيف الوقت**: تصنيف الوقت حسب نوع النشاط (مثل البحث، كتابة المستندات، الاجتماعات)
- **تحديد قابلية الفوترة**: تحديد ما إذا كان الوقت قابلاً للفوترة أم لا
- **تعديل وحذف سجلات الوقت**: القدرة على تعديل أو حذف سجلات الوقت (مع تتبع التغييرات)
- **التعليقات والملاحظات**: إضافة تعليقات وملاحظات لكل إدخال وقت

#### 2. إدارة الفوترة
- **إنشاء فواتير من سجلات الوقت**: تحويل سجلات الوقت إلى بنود فواتير
- **معدلات الفوترة المتعددة**: دعم معدلات فوترة مختلفة حسب المحامي، نوع القضية، أو العميل
- **خصومات وتعديلات**: تطبيق خصومات أو تعديلات على الفواتير
- **معاينة الفواتير**: معاينة الفواتير قبل إنشائها
- **جدولة الفوترة**: إعداد جداول فوترة دورية (شهرية، ربع سنوية)
- **تتبع حالة الفوترة**: تتبع حالة سجلات الوقت (غير مفوترة، مفوترة، مدفوعة)
- **التكامل مع وحدة المالية**: إنشاء فواتير في النظام المالي

#### 3. إعدادات وتكوين النظام
- **إعداد معدلات الفوترة**: تحديد معدلات الفوترة الافتراضية للمحامين والخدمات
- **أنواع الأنشطة**: تكوين أنواع الأنشطة القانونية
- **قوالب الفواتير**: إنشاء وتخصيص قوالب الفواتير
- **أهداف الساعات**: تحديد أهداف الساعات القابلة للفوترة للمحامين
- **إعدادات التقريب**: تكوين قواعد تقريب الوقت (مثل كل 6 دقائق، 15 دقيقة)

#### 4. التقارير والتحليلات
- **تقارير الإنتاجية**: تحليل إنتاجية المحامين والموظفين
- **تقارير الربحية**: تحليل ربحية القضايا والعملاء
- **تقارير الوقت**: عرض سجلات الوقت حسب المحامي، القضية، العميل، أو الفترة الزمنية
- **تقارير الفوترة**: تحليل معدلات الفوترة والتحصيل
- **لوحات المعلومات**: لوحات معلومات تفاعلية لعرض مؤشرات الأداء الرئيسية
- **تصدير التقارير**: تصدير التقارير بتنسيقات مختلفة (PDF، Excel)

#### 5. التكامل مع الوحدات الأخرى
- **تكامل مع وحدة القضايا**: ربط سجلات الوقت بالقضايا والمهام
- **تكامل مع وحدة العملاء**: ربط سجلات الوقت والفواتير بالعملاء
- **تكامل مع وحدة المالية**: إنشاء فواتير وتتبع المدفوعات
- **تكامل مع وحدة الموارد البشرية**: تتبع ساعات عمل الموظفين لأغراض الرواتب

### المتطلبات غير الوظيفية
1. **سهولة الاستخدام**: واجهة مستخدم بديهية لتسجيل الوقت بسرعة وسهولة
2. **الأداء**: معالجة سريعة لسجلات الوقت والفواتير
3. **الموثوقية**: ضمان دقة حساب الوقت والفواتير
4. **الأمان**: حماية بيانات العملاء والفواتير
5. **قابلية التوسع**: دعم عدد كبير من المستخدمين وسجلات الوقت
6. **التوافق مع الأجهزة المحمولة**: تسجيل الوقت من الأجهزة المحمولة

### نماذج البيانات المقترحة

#### 1. نموذج سجل الوقت (TimeEntry)
- معرف فريد (id)
- معرف المستخدم/الموظف (user_id)
- معرف القضية (case_id) - اختياري
- معرف المهمة (task_id) - اختياري
- معرف العميل (client_id) - اختياري
- تاريخ النشاط (activity_date)
- وقت البدء (start_time) - اختياري
- وقت الانتهاء (end_time) - اختياري
- المدة بالساعات (duration_hours)
- نوع النشاط (activity_type)
- وصف النشاط (description)
- قابل للفوترة (is_billable)
- معدل الفوترة (billing_rate)
- حالة الفوترة (billing_status): غير مفوتر، مفوتر، مدفوع
- معرف الفاتورة (invoice_id) - اختياري
- معرف المستأجر (tenant_id)
- تاريخ الإنشاء (created_at)
- تاريخ التحديث (updated_at)
- منشئ السجل (created_by)
- محدث السجل (updated_by)

#### 2. نموذج معدل الفوترة (BillingRate)
- معرف فريد (id)
- الاسم (name)
- المعدل بالساعة (hourly_rate)
- معرف المستخدم/الموظف (user_id) - اختياري
- معرف العميل (client_id) - اختياري
- معرف نوع القضية (case_type_id) - اختياري
- معرف نوع النشاط (activity_type_id) - اختياري
- تاريخ البدء (effective_date)
- تاريخ الانتهاء (end_date) - اختياري
- معرف المستأجر (tenant_id)
- تاريخ الإنشاء (created_at)
- تاريخ التحديث (updated_at)
- منشئ السجل (created_by)
- محدث السجل (updated_by)

#### 3. نموذج نوع النشاط (ActivityType)
- معرف فريد (id)
- الاسم (name)
- الوصف (description)
- قابل للفوترة افتراضياً (default_billable)
- معدل الفوترة الافتراضي (default_rate) - اختياري
- نشط (is_active)
- معرف المستأجر (tenant_id)
- تاريخ الإنشاء (created_at)
- تاريخ التحديث (updated_at)
- منشئ السجل (created_by)
- محدث السجل (updated_by)

#### 4. نموذج هدف الساعات (TimeTarget)
- معرف فريد (id)
- معرف المستخدم/الموظف (user_id)
- الفترة (period): شهري، ربع سنوي، سنوي
- تاريخ البدء (start_date)
- تاريخ الانتهاء (end_date)
- هدف الساعات القابلة للفوترة (billable_hours_target)
- هدف الساعات غير القابلة للفوترة (non_billable_hours_target) - اختياري
- معرف المستأجر (tenant_id)
- تاريخ الإنشاء (created_at)
- تاريخ التحديث (updated_at)
- منشئ السجل (created_by)
- محدث السجل (updated_by)

### واجهات المستخدم المقترحة

1. **صفحة تسجيل الوقت**
   - نموذج لإدخال سجلات الوقت
   - ساعة توقيت لتسجيل الوقت المباشر
   - عرض سجلات الوقت الحالية والسابقة

2. **لوحة معلومات تتبع الوقت**
   - ملخص الوقت المسجل (اليوم، الأسبوع، الشهر)
   - مقارنة الوقت القابل للفوترة وغير القابل للفوترة
   - التقدم نحو أهداف الساعات

3. **صفحة إدارة الفوترة**
   - قائمة بسجلات الوقت غير المفوترة
   - إنشاء فواتير من سجلات الوقت
   - معاينة وتعديل الفواتير قبل الإنشاء

4. **صفحة التقارير**
   - تقارير الإنتاجية
   - تقارير الربحية
   - تقارير الوقت والفوترة

5. **صفحة الإعدادات**
   - إدارة معدلات الفوترة
   - إدارة أنواع الأنشطة
   - تكوين قوالب الفواتير
   - إعداد أهداف الساعات

### خطة التنفيذ

1. **المرحلة 1: تطوير نماذج البيانات والواجهة الخلفية**
   - تنفيذ نماذج البيانات
   - تطوير وحدات التحكم (Controllers) والمسارات (Routes)
   - تنفيذ منطق الأعمال لتسجيل الوقت والفوترة

2. **المرحلة 2: تطوير واجهة المستخدم**
   - تنفيذ صفحة تسجيل الوقت
   - تنفيذ لوحة معلومات تتبع الوقت
   - تنفيذ صفحة إدارة الفوترة

3. **المرحلة 3: التكامل والاختبار**
   - التكامل مع وحدة الإدارة المالية
   - التكامل مع وحدات القضايا والعملاء
   - اختبار الوظائف والأداء

4. **المرحلة 4: التقارير والتحسينات**
   - تنفيذ التقارير والتحليلات
   - تحسين واجهة المستخدم والأداء
   - توثيق الوحدة
