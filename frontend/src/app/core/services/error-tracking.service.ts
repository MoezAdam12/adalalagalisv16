/**
 * error-tracking.service.ts
 * ุฎุฏูุฉ ุชุชุจุน ุงูุฃุฎุทุงุก ูุฅุนุฏุงุฏ ุงูุชูุงุฑูุฑ ูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ
 */

import { Injectable, ErrorHandler, Injector } from '@angular/core';
import { HttpErrorResponse } from '@angular/common/http';
import { Router } from '@angular/router';
import { environment } from '../../../environments/environment';

/**
 * ูุงุฌูุฉ ูุชูุซูู ุงูุฎุทุฃ ุงูููุณู
 */
export interface FormattedError {
  name: string;
  message: string;
  stack?: string;
  timestamp: string;
  url: string;
  userId?: string;
  sessionId?: string;
  browser: string;
  device: string;
  os: string;
  metadata?: any;
}

/**
 * ุฎุฏูุฉ ุชุชุจุน ุงูุฃุฎุทุงุก ูุฅุนุฏุงุฏ ุงูุชูุงุฑูุฑ
 * ุชููุฑ ุขููุฉ ูุฑูุฒูุฉ ูุชุชุจุน ุงูุฃุฎุทุงุก ูุฅุนุฏุงุฏ ุงูุชูุงุฑูุฑ ูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ
 */
@Injectable({
  providedIn: 'root'
})
export class ErrorTrackingService implements ErrorHandler {
  private readonly MAX_STORED_ERRORS = 50;
  private readonly ERROR_STORAGE_KEY = 'adalalegalis_error_log';
  private readonly SESSION_ID = this.generateSessionId();
  
  constructor(private injector: Injector) {}

  /**
   * ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงููุฑุณูุฉ ูู Angular
   * @param error ุงูุฎุทุฃ ุงููุฑุงุฏ ูุนุงูุฌุชู
   */
  handleError(error: any): void {
    try {
      // ุชูุณูู ุงูุฎุทุฃ
      const formattedError = this.formatError(error);
      
      // ุชุณุฌูู ุงูุฎุทุฃ ูู ูุญุฏุฉ ุงูุชุญูู
      this.logErrorToConsole(formattedError);
      
      // ุชุฎุฒูู ุงูุฎุทุฃ ูุญูููุง
      this.storeErrorLocally(formattedError);
      
      // ุฅุฑุณุงู ุงูุฎุทุฃ ุฅูู ุงูุฎุงุฏู ุฅุฐุง ูุงู ุฐูู ููุงุณุจูุง
      this.reportErrorToServer(formattedError);
      
      // ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูููุณุชุฎุฏู ุฅุฐุง ูุงู ุฐูู ููุงุณุจูุง
      this.showUserFriendlyError(error);
      
      // ุฅุนุงุฏุฉ ุชูุฌูู ุงููุณุชุฎุฏู ุฅูู ุตูุญุฉ ุงูุฎุทุฃ ุฅุฐุง ูุงู ุฐูู ููุงุณุจูุง
      this.redirectToErrorPage(error);
    } catch (handlingError) {
      // ูู ุญุงูุฉ ุญุฏูุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุฎุทุฃุ ูุณุฌู ุฐูู ูู ูุญุฏุฉ ุงูุชุญูู
      console.error('ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุฎุทุฃ:', handlingError);
      console.error('ุงูุฎุทุฃ ุงูุฃุตูู:', error);
    }
  }

  /**
   * ุชูุณูู ุงูุฎุทุฃ ุฅูู ูููู ููุญุฏ
   * @param error ุงูุฎุทุฃ ุงููุฑุงุฏ ุชูุณููู
   * @returns ุงูุฎุทุฃ ุงูููุณู
   */
  private formatError(error: any): FormattedError {
    // ุงุณุชุฎุฑุงุฌ ูุนูููุงุช ุงูุฎุทุฃ
    const name = error.name || (error instanceof HttpErrorResponse ? 'HttpErrorResponse' : 'Error');
    const message = error.message || 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุนุฑูู';
    const stack = error.stack;
    const timestamp = new Date().toISOString();
    const url = this.getCurrentUrl();
    
    // ุงุณุชุฎุฑุงุฌ ูุนูููุงุช ุงููุณุชุฎุฏู
    const userId = this.getUserId();
    
    // ุงุณุชุฎุฑุงุฌ ูุนูููุงุช ุงููุชุตูุญ ูุงูุฌูุงุฒ
    const browser = this.getBrowserInfo();
    const device = this.getDeviceInfo();
    const os = this.getOSInfo();
    
    // ุฅุถุงูุฉ ุจูุงูุงุช ูุตููุฉ ุฅุถุงููุฉ
    const metadata: any = {};
    
    // ุฅุถุงูุฉ ูุนูููุงุช ุฅุถุงููุฉ ูุฃุฎุทุงุก HTTP
    if (error instanceof HttpErrorResponse) {
      metadata.status = error.status;
      metadata.statusText = error.statusText;
      metadata.url = error.url;
      
      if (error.error) {
        if (typeof error.error === 'string') {
          try {
            metadata.serverError = JSON.parse(error.error);
          } catch {
            metadata.serverError = error.error;
          }
        } else {
          metadata.serverError = error.error;
        }
      }
    }
    
    return {
      name,
      message,
      stack,
      timestamp,
      url,
      userId,
      sessionId: this.SESSION_ID,
      browser,
      device,
      os,
      metadata
    };
  }

  /**
   * ุชุณุฌูู ุงูุฎุทุฃ ูู ูุญุฏุฉ ุงูุชุญูู
   * @param error ุงูุฎุทุฃ ุงูููุณู
   */
  private logErrorToConsole(error: FormattedError): void {
    if (environment.debug.enabled) {
      console.group('%c๐ ุฎุทุฃ ูู ุงูุชุทุจูู', 'color: #ff0000; font-weight: bold; font-size: 14px;');
      console.log(`%c${error.name}: ${error.message}`, 'color: #ff6666;');
      console.log('ุงูููุช:', error.timestamp);
      console.log('ุงููุณุงุฑ:', error.url);
      console.log('ูุนุฑู ุงูุฌูุณุฉ:', error.sessionId);
      
      if (error.userId) {
        console.log('ูุนุฑู ุงููุณุชุฎุฏู:', error.userId);
      }
      
      console.log('ุงููุชุตูุญ:', error.browser);
      console.log('ุงูุฌูุงุฒ:', error.device);
      console.log('ูุธุงู ุงูุชุดุบูู:', error.os);
      
      if (error.metadata && Object.keys(error.metadata).length > 0) {
        console.log('ุจูุงูุงุช ุฅุถุงููุฉ:', error.metadata);
      }
      
      if (error.stack) {
        console.log('ุชุชุจุน ุงูููุฏุณ:');
        console.log(error.stack);
      }
      
      console.groupEnd();
    } else {
      console.error(`${error.name}: ${error.message}`);
    }
  }

  /**
   * ุชุฎุฒูู ุงูุฎุทุฃ ูุญูููุง
   * @param error ุงูุฎุทุฃ ุงูููุณู
   */
  private storeErrorLocally(error: FormattedError): void {
    try {
      // ุงูุญุตูู ุนูู ุงูุฃุฎุทุงุก ุงููุฎุฒูุฉ ุณุงุจููุง
      const storedErrors = this.getStoredErrors();
      
      // ุฅุถุงูุฉ ุงูุฎุทุฃ ุงูุฌุฏูุฏ
      storedErrors.unshift(error);
      
      // ุงูุงุญุชูุงุธ ููุท ุจุงูุนุฏุฏ ุงููุญุฏุฏ ูู ุงูุฃุฎุทุงุก
      if (storedErrors.length > this.MAX_STORED_ERRORS) {
        storedErrors.length = this.MAX_STORED_ERRORS;
      }
      
      // ุชุฎุฒูู ุงูุฃุฎุทุงุก ุงููุญุฏุซุฉ
      localStorage.setItem(this.ERROR_STORAGE_KEY, JSON.stringify(storedErrors));
    } catch (e) {
      // ุชุฌุงูู ุฃุฎุทุงุก ุงูุชุฎุฒูู ุงููุญูู
      console.warn('ูุดู ุชุฎุฒูู ุงูุฎุทุฃ ูุญูููุง:', e);
    }
  }

  /**
   * ุงูุญุตูู ุนูู ุงูุฃุฎุทุงุก ุงููุฎุฒูุฉ ูุญูููุง
   * @returns ูุตูููุฉ ุงูุฃุฎุทุงุก ุงููุฎุฒูุฉ
   */
  private getStoredErrors(): FormattedError[] {
    try {
      const storedErrors = localStorage.getItem(this.ERROR_STORAGE_KEY);
      return storedErrors ? JSON.parse(storedErrors) : [];
    } catch (e) {
      return [];
    }
  }

  /**
   * ุฅุฑุณุงู ุงูุฎุทุฃ ุฅูู ุงูุฎุงุฏู
   * @param error ุงูุฎุทุฃ ุงูููุณู
   */
  private reportErrorToServer(error: FormattedError): void {
    // ุชุญูู ููุง ุฅุฐุง ูุงู ุงูุฅุจูุงุบ ุนู ุงูุฃุฎุทุงุก ููุนููุง
    if (environment.analytics.logErrors) {
      // ุชุฌุงูู ุจุนุถ ุงูุฃุฎุทุงุก ุบูุฑ ุงููููุฉ
      if (this.shouldIgnoreError(error)) {
        return;
      }
      
      // ุฅุฑุณุงู ุงูุฎุทุฃ ุฅูู ุงูุฎุงุฏู
      // ูููู ุงุณุชุฎุฏุงู ุฎุฏูุฉ HTTP ููุง ูุฅุฑุณุงู ุงูุฎุทุฃ ุฅูู ููุทุฉ ููุงูุฉ API
      // ุฃู ุงุณุชุฎุฏุงู ุฎุฏูุฉ ุชุชุจุน ุงูุฃุฎุทุงุก ูุซู Sentry ุฃู LogRocket
      
      // ูุซุงู ุนูู ุฅุฑุณุงู ุงูุฎุทุฃ ุจุงุณุชุฎุฏุงู fetch
      if (navigator.onLine) {
        const errorData = {
          ...error,
          appVersion: environment.apiVersion,
          environment: environment.production ? 'production' : environment.staging ? 'staging' : 'development'
        };
        
        // ุชุฌุงูู ุชุชุจุน ุงูููุฏุณ ูู ุงูุฅูุชุงุฌ ูุชูููู ุญุฌู ุงูุจูุงูุงุช
        if (environment.production) {
          delete errorData.stack;
        }
        
        // ุฅุฑุณุงู ุงูุฎุทุฃ ุฅูู ุงูุฎุงุฏู
        fetch(`${environment.apiUrl}/errors`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(errorData),
          // ุงุณุชุฎุฏุงู keepalive ูุถูุงู ุฅุฑุณุงู ุงูุทูุจ ุญุชู ุฅุฐุง ุชู ุฅุบูุงู ุงูุตูุญุฉ
          keepalive: true
        }).catch(e => {
          // ุชุฌุงูู ุฃุฎุทุงุก ุงูุฅุฑุณุงู
          console.warn('ูุดู ุฅุฑุณุงู ุงูุฎุทุฃ ุฅูู ุงูุฎุงุฏู:', e);
        });
      } else {
        // ุชุฎุฒูู ุงูุฎุทุฃ ูุฅุฑุณุงูู ูุงุญููุง ุนูุฏูุง ูููู ุงูุงุชุตุงู ูุชุงุญูุง
        this.queueErrorForLaterSending(error);
      }
    }
  }

  /**
   * ุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ูุฌุจ ุชุฌุงูู ุงูุฎุทุฃ
   * @param error ุงูุฎุทุฃ ุงูููุณู
   * @returns true ุฅุฐุง ูุงู ูุฌุจ ุชุฌุงูู ุงูุฎุทุฃุ false ุฎูุงู ุฐูู
   */
  private shouldIgnoreError(error: FormattedError): boolean {
    // ุชุฌุงูู ุฃุฎุทุงุก CORS
    if (error.message.includes('Access to XMLHttpRequest') && error.message.includes('has been blocked by CORS policy')) {
      return true;
    }
    
    // ุชุฌุงูู ุฃุฎุทุงุก ุงูุดุจูุฉ ุงูุนุงูุฉ
    if (error.name === 'HttpErrorResponse' && error.message.includes('Unknown Error')) {
      return true;
    }
    
    // ุชุฌุงูู ุฃุฎุทุงุก ุฅูุบุงุก ุงูุทูุจุงุช
    if (error.message.includes('cancelled') || error.message.includes('aborted')) {
      return true;
    }
    
    // ุชุฌุงูู ุฃุฎุทุงุก ุงูุงูุชุฏุงุฏุงุช ูุงูุฅุถุงูุงุช
    if (error.stack && (error.stack.includes('chrome-extension://') || error.stack.includes('moz-extension://'))) {
      return true;
    }
    
    return false;
  }

  /**
   * ูุถุน ุงูุฎุทุฃ ูู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ูุฅุฑุณุงูู ูุงุญููุง
   * @param error ุงูุฎุทุฃ ุงูููุณู
   */
  private queueErrorForLaterSending(error: FormattedError): void {
    try {
      // ุงูุญุตูู ุนูู ูุงุฆูุฉ ุงูุฃุฎุทุงุก ุงูููุชุธุฑุฉ
      const queueKey = 'adalalegalis_error_queue';
      const queuedErrors = JSON.parse(localStorage.getItem(queueKey) || '[]');
      
      // ุฅุถุงูุฉ ุงูุฎุทุฃ ุงูุฌุฏูุฏ
      queuedErrors.push(error);
      
      // ุชุฎุฒูู ุงููุงุฆูุฉ ุงููุญุฏุซุฉ
      localStorage.setItem(queueKey, JSON.stringify(queuedErrors));
      
      // ุฅุถุงูุฉ ูุณุชูุน ูุญุฏุซ ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช ูุฅุฑุณุงู ุงูุฃุฎุทุงุก ุงูููุชุธุฑุฉ
      window.addEventListener('online', this.sendQueuedErrors.bind(this), { once: true });
    } catch (e) {
      // ุชุฌุงูู ุฃุฎุทุงุก ุงูุชุฎุฒูู ุงููุญูู
      console.warn('ูุดู ูุถุน ุงูุฎุทุฃ ูู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ:', e);
    }
  }

  /**
   * ุฅุฑุณุงู ุงูุฃุฎุทุงุก ุงูููุชุธุฑุฉ ุนูุฏูุง ูููู ุงูุงุชุตุงู ูุชุงุญูุง
   */
  private sendQueuedErrors(): void {
    try {
      // ุงูุญุตูู ุนูู ูุงุฆูุฉ ุงูุฃุฎุทุงุก ุงูููุชุธุฑุฉ
      const queueKey = 'adalalegalis_error_queue';
      const queuedErrors = JSON.parse(localStorage.getItem(queueKey) || '[]');
      
      if (queuedErrors.length === 0) {
        return;
      }
      
      // ุฅุฑุณุงู ุงูุฃุฎุทุงุก ุงูููุชุธุฑุฉ
      const apiUrl = `${environment.apiUrl}/errors/batch`;
      
      fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          errors: queuedErrors,
          appVersion: environment.apiVersion,
          environment: environment.production ? 'production' : environment.staging ? 'staging' : 'development'
        })
      })
      .then(response => {
        if (response.ok) {
          // ูุณุญ ุงูุฃุฎุทุงุก ุงูููุชุธุฑุฉ ุจุนุฏ ุฅุฑุณุงููุง ุจูุฌุงุญ
          localStorage.removeItem(queueKey);
        }
      })
      .catch(e => {
        console.warn('ูุดู ุฅุฑุณุงู ุงูุฃุฎุทุงุก ุงูููุชุธุฑุฉ:', e);
        // ุฅุนุงุฏุฉ ุฅุถุงูุฉ ูุณุชูุน ููุญุงููุฉ ูุงุญูุฉ
        window.addEventListener('online', this.sendQueuedErrors.bind(this), { once: true });
      });
    } catch (e) {
      console.warn('ูุดู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงูููุชุธุฑุฉ:', e);
    }
  }

  /**
   * ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ุตุฏููุฉ ูููุณุชุฎุฏู
   * @param error ุงูุฎุทุฃ ุงูุฃุตูู
   */
  private showUserFriendlyError(error: any): void {
    // ุงูุญุตูู ุนูู ุฎุฏูุฉ ุงูุฅุดุนุงุฑุงุช
    try {
      // ูููู ุงุณุชุฎุฏุงู ุฎุฏูุฉ ุงูุฅุดุนุงุฑุงุช ููุง ูุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูููุณุชุฎุฏู
      // ูุซุงู: this.injector.get(NotificationService).showError(message);
      
      // ุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ูุฌุจ ุนุฑุถ ุงูุฎุทุฃ ูููุณุชุฎุฏู
      if (this.shouldShowErrorToUser(error)) {
        let message = 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
        
        // ุชุฎุตูุต ุงูุฑุณุงูุฉ ุจูุงุกู ุนูู ููุน ุงูุฎุทุฃ
        if (error instanceof HttpErrorResponse) {
          switch (error.status) {
            case 0:
              message = 'ูุง ูููู ุงูุงุชุตุงู ุจุงูุฎุงุฏู. ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงูู ุจุงูุฅูุชุฑูุช.';
              break;
            case 400:
              message = 'ุทูุจ ุบูุฑ ุตุงูุญ. ูุฑุฌู ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุฏุฎูุฉ.';
              break;
            case 401:
              message = 'ุฌูุณุชู ุงูุชูุช. ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู.';
              break;
            case 403:
              message = 'ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ุฅูู ูุฐุง ุงูููุฑุฏ.';
              break;
            case 404:
              message = 'ุงูููุฑุฏ ุงููุทููุจ ุบูุฑ ููุฌูุฏ.';
              break;
            case 500:
              message = 'ุญุฏุซ ุฎุทุฃ ูู ุงูุฎุงุฏู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ูุงุญููุง.';
              break;
            default:
              if (error.error && error.error.message) {
                message = error.error.message;
              }
          }
        }
        
        // ุนุฑุถ ุงูุฑุณุงูุฉ ูููุณุชุฎุฏู
        // ูุซุงู: this.injector.get(NotificationService).showError(message);
        console.warn('ุฑุณุงูุฉ ุงูุฎุทุฃ ูููุณุชุฎุฏู:', message);
      }
    } catch (e) {
      // ุชุฌุงูู ุฃุฎุทุงุก ุนุฑุถ ุงูุฅุดุนุงุฑุงุช
      console.warn('ูุดู ุนุฑุถ ุฑุณุงูุฉ ุงูุฎุทุฃ ูููุณุชุฎุฏู:', e);
    }
  }

  /**
   * ุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ูุฌุจ ุนุฑุถ ุงูุฎุทุฃ ูููุณุชุฎุฏู
   * @param error ุงูุฎุทุฃ ุงูุฃุตูู
   * @returns true ุฅุฐุง ูุงู ูุฌุจ ุนุฑุถ ุงูุฎุทุฃ ูููุณุชุฎุฏูุ false ุฎูุงู ุฐูู
   */
  private shouldShowErrorToUser(error: any): boolean {
    // ุนุฑุถ ุฃุฎุทุงุก HTTP ูููุณุชุฎุฏู
    if (error instanceof HttpErrorResponse) {
      // ุชุฌุงูู ุฃุฎุทุงุก ุฅูุบุงุก ุงูุทูุจุงุช
      if (error.name === 'HttpErrorResponse' && error.message.includes('cancelled')) {
        return false;
      }
      
      // ุนุฑุถ ุฃุฎุทุงุก ุงูุฎุงุฏู ูุงููุตุงุฏูุฉ
      return true;
    }
    
    // ุชุฌุงูู ุฃุฎุทุงุก ุงูุชุทุจูู ุงูุฏุงุฎููุฉ ูู ุงูุฅูุชุงุฌ
    if (environment.production) {
      return false;
    }
    
    // ุนุฑุถ ุฌููุน ุงูุฃุฎุทุงุก ูู ุจูุฆุฉ ุงูุชุทููุฑ
    return true;
  }

  /**
   * ุฅุนุงุฏุฉ ุชูุฌูู ุงููุณุชุฎุฏู ุฅูู ุตูุญุฉ ุงูุฎุทุฃ
   * @param error ุงูุฎุทุฃ ุงูุฃุตูู
   */
  private redirectToErrorPage(error: any): void {
    // ุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ูุฌุจ ุฅุนุงุฏุฉ ุงูุชูุฌูู
    if (this.shouldRedirectToErrorPage(error)) {
      try {
        const router = this.injector.get(Router);
        
        // ุชุญุฏูุฏ ุตูุญุฉ ุงูุฎุทุฃ ุงูููุงุณุจุฉ
        let errorRoute = '/error';
        
        if (error instanceof HttpErrorResponse) {
          switch (error.status) {
            case 401:
              errorRoute = '/auth/login';
              break;
            case 403:
              errorRoute = '/error/forbidden';
              break;
            case 404:
              errorRoute = '/error/not-found';
              break;
            case 500:
              errorRoute = '/error/server';
              break;
          }
        }
        
        // ุฅุนุงุฏุฉ ุงูุชูุฌูู ุฅูู ุตูุญุฉ ุงูุฎุทุฃ
        router.navigate([errorRoute], {
          queryParams: {
            errorId: this.SESSION_ID,
            timestamp: new Date().getTime()
          }
        });
      } catch (e) {
        // ุชุฌุงูู ุฃุฎุทุงุก ุฅุนุงุฏุฉ ุงูุชูุฌูู
        console.warn('ูุดู ุฅุนุงุฏุฉ ุงูุชูุฌูู ุฅูู ุตูุญุฉ ุงูุฎุทุฃ:', e);
      }
    }
  }

  /**
   * ุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ูุฌุจ ุฅุนุงุฏุฉ ุงูุชูุฌูู ุฅูู ุตูุญุฉ ุงูุฎุทุฃ
   * @param error ุงูุฎุทุฃ ุงูุฃุตูู
   * @returns true ุฅุฐุง ูุงู ูุฌุจ ุฅุนุงุฏุฉ ุงูุชูุฌููุ false ุฎูุงู ุฐูู
   */
  private shouldRedirectToErrorPage(error: any): boolean {
    // ุฅุนุงุฏุฉ ุงูุชูุฌูู ููุท ูุฃุฎุทุงุก HTTP ุงูุญุฑุฌุฉ
    if (error instanceof HttpErrorResponse) {
      // ุฅุนุงุฏุฉ ุงูุชูุฌูู ูุฃุฎุทุงุก ุงููุตุงุฏูุฉ ูุงูุตูุงุญูุงุช
      if (error.status === 401 || error.status === 403) {
        return true;
      }
      
      // ุฅุนุงุฏุฉ ุงูุชูุฌูู ูุฃุฎุทุงุก ุงูุฎุงุฏู ุงูุญุฑุฌุฉ
      if (error.status === 500 || error.status === 503) {
        return true;
      }
    }
    
    // ูุง ุฅุนุงุฏุฉ ุชูุฌูู ููุฃุฎุทุงุก ุงูุฃุฎุฑู
    return false;
  }

  /**
   * ุงูุญุตูู ุนูู ุงููุณุงุฑ ุงูุญุงูู
   * @returns ุงููุณุงุฑ ุงูุญุงูู
   */
  private getCurrentUrl(): string {
    return window.location.href;
  }

  /**
   * ุงูุญุตูู ุนูู ูุนุฑู ุงููุณุชุฎุฏู
   * @returns ูุนุฑู ุงููุณุชุฎุฏู ุฅุฐุง ูุงู ูุชุงุญูุง
   */
  private getUserId(): string | undefined {
    try {
      // ูููู ุงุณุชุฎุฏุงู ุฎุฏูุฉ ุงููุตุงุฏูุฉ ููุง ููุญุตูู ุนูู ูุนุฑู ุงููุณุชุฎุฏู
      // ูุซุงู: return this.injector.get(AuthService).getUserId();
      
      // ุจุฏูู: ูุญุงููุฉ ุงูุญุตูู ุนูู ูุนุฑู ุงููุณุชุฎุฏู ูู ุงูุชุฎุฒูู ุงููุญูู
      const userDataStr = localStorage.getItem('adalalegalis_user');
      if (userDataStr) {
        const userData = JSON.parse(userDataStr);
        return userData.id;
      }
    } catch (e) {
      // ุชุฌุงูู ุฃุฎุทุงุก ุงูุญุตูู ุนูู ูุนุฑู ุงููุณุชุฎุฏู
    }
    
    return undefined;
  }

  /**
   * ุงูุญุตูู ุนูู ูุนูููุงุช ุงููุชุตูุญ
   * @returns ูุนูููุงุช ุงููุชุตูุญ
   */
  private getBrowserInfo(): string {
    const userAgent = navigator.userAgent;
    let browser = 'ุบูุฑ ูุนุฑูู';
    
    if (userAgent.indexOf('Firefox') > -1) {
      browser = 'Firefox';
    } else if (userAgent.indexOf('SamsungBrowser') > -1) {
      browser = 'Samsung Browser';
    } else if (userAgent.indexOf('Opera') > -1 || userAgent.indexOf('OPR') > -1) {
      browser = 'Opera';
    } else if (userAgent.indexOf('Trident') > -1) {
      browser = 'Internet Explorer';
    } else if (userAgent.indexOf('Edge') > -1) {
      browser = 'Edge (Legacy)';
    } else if (userAgent.indexOf('Edg') > -1) {
      browser = 'Edge (Chromium)';
    } else if (userAgent.indexOf('Chrome') > -1) {
      browser = 'Chrome';
    } else if (userAgent.indexOf('Safari') > -1) {
      browser = 'Safari';
    }
    
    return browser;
  }

  /**
   * ุงูุญุตูู ุนูู ูุนูููุงุช ุงูุฌูุงุฒ
   * @returns ูุนูููุงุช ุงูุฌูุงุฒ
   */
  private getDeviceInfo(): string {
    const userAgent = navigator.userAgent;
    
    if (/iPad/.test(userAgent)) {
      return 'iPad';
    } else if (/iPhone/.test(userAgent)) {
      return 'iPhone';
    } else if (/Android/.test(userAgent)) {
      return 'Android';
    } else if (/Windows Phone/.test(userAgent)) {
      return 'Windows Phone';
    } else if (/Windows/.test(userAgent)) {
      return 'Desktop (Windows)';
    } else if (/Macintosh/.test(userAgent)) {
      return 'Desktop (Mac)';
    } else if (/Linux/.test(userAgent)) {
      return 'Desktop (Linux)';
    }
    
    return 'ุบูุฑ ูุนุฑูู';
  }

  /**
   * ุงูุญุตูู ุนูู ูุนูููุงุช ูุธุงู ุงูุชุดุบูู
   * @returns ูุนูููุงุช ูุธุงู ุงูุชุดุบูู
   */
  private getOSInfo(): string {
    const userAgent = navigator.userAgent;
    let os = 'ุบูุฑ ูุนุฑูู';
    
    if (/Windows NT 10.0/.test(userAgent)) {
      os = 'Windows 10';
    } else if (/Windows NT 6.3/.test(userAgent)) {
      os = 'Windows 8.1';
    } else if (/Windows NT 6.2/.test(userAgent)) {
      os = 'Windows 8';
    } else if (/Windows NT 6.1/.test(userAgent)) {
      os = 'Windows 7';
    } else if (/Windows NT 6.0/.test(userAgent)) {
      os = 'Windows Vista';
    } else if (/Windows NT 5.1/.test(userAgent)) {
      os = 'Windows XP';
    } else if (/Windows/.test(userAgent)) {
      os = 'Windows';
    } else if (/Android/.test(userAgent)) {
      os = 'Android';
    } else if (/iPhone|iPad|iPod/.test(userAgent)) {
      os = 'iOS';
    } else if (/Mac/.test(userAgent)) {
      os = 'macOS';
    } else if (/Linux/.test(userAgent)) {
      os = 'Linux';
    }
    
    return os;
  }

  /**
   * ุฅูุดุงุก ูุนุฑู ุฌูุณุฉ ูุฑูุฏ
   * @returns ูุนุฑู ุงูุฌูุณุฉ
   */
  private generateSessionId(): string {
    return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
  }

  /**
   * ุงูุญุตูู ุนูู ุงูุฃุฎุทุงุก ุงููุฎุฒูุฉ
   * @returns ูุตูููุฉ ุงูุฃุฎุทุงุก ุงููุฎุฒูุฉ
   */
  getErrors(): FormattedError[] {
    return this.getStoredErrors();
  }

  /**
   * ูุณุญ ุงูุฃุฎุทุงุก ุงููุฎุฒูุฉ
   */
  clearErrors(): void {
    localStorage.removeItem(this.ERROR_STORAGE_KEY);
  }
}
